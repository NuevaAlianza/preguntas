<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Consulta de Preguntas</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      margin: 0;
      background: #f0f0f0;
      color: #333;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 1em;
      border-radius: 1em;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      font-size: 1.5em;
      text-align: center;
    }
    select, button {
      width: 100%;
      padding: 0.5em;
      margin: 0.5em 0;
      font-size: 1em;
    }
    .question, .answer, .progress-bar {
      margin: 1em 0;
    }
    .progress-bar {
      height: 20px;
      width: 100%;
      background: #ccc;
      border-radius: 10px;
      overflow: hidden;
    }
    .progress {
      height: 100%;
      width: 100%;
      background: green;
      transition: width 1s linear;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Consulta de Preguntas</h1>
  <p id="total">Cargando preguntas...</p>
  <div>
    <label>Selecciona hasta 3 temas:</label>
    <select id="topics" multiple size="5"></select>
    <button id="selectBtn">Seleccionar preguntas</button>
  </div>
  <div>
    <button id="nextBtn" class="hidden">Ver siguiente pregunta</button>
    <div class="question hidden" id="questionBox"></div>
    <div class="progress-bar hidden">
      <div class="progress" id="progress"></div>
    </div>
    <button id="showAnswerBtn" class="hidden">Mostrar respuesta ahora</button>
    <div class="answer hidden" id="answerBox"></div>
  </div>
</div>
<script>
let questions = [], selected = [], current = 0, timer;
let csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTdFQb05RiZ5CPUh8brf-HWARLiMs-UaQFdXRj8iZmonLnKJr_R6Mlzy8FDnGkKc1rZC2SS5LvHx4aa/pub?output=csv";

fetch(csvUrl)
  .then(res => res.text())
  .then(data => {
    questions = data.trim().split("\n").map(row => {
      let [q, a, t] = row.split(",");
      return { pregunta: q, respuesta: a, tema: t };
    });
    document.getElementById("total").innerText = `${questions.length} preguntas disponibles.`;
    let temas = [...new Set(questions.map(q => q.tema))];
    let select = document.getElementById("topics");
    temas.forEach(t => {
      let opt = document.createElement("option");
      opt.value = t;
      opt.textContent = t;
      select.appendChild(opt);
    });
  });

function shuffle(arr) {
  return arr.sort(() => Math.random() - 0.5);
}

document.getElementById("selectBtn").onclick = () => {
  let selectedTopics = Array.from(document.getElementById("topics").selectedOptions).map(o => o.value);
  if (selectedTopics.length === 0 || selectedTopics.length > 3) {
    alert("Selecciona entre 1 y 3 temas.");
    return;
  }
  selected = shuffle(questions.filter(q => selectedTopics.includes(q.tema))).slice(0, 15);
  current = 0;
  document.getElementById("nextBtn").classList.remove("hidden");
  document.getElementById("questionBox").classList.add("hidden");
  document.getElementById("answerBox").classList.add("hidden");
  document.getElementById("showAnswerBtn").classList.add("hidden");
};

document.getElementById("nextBtn").onclick = showQuestion;

document.getElementById("showAnswerBtn").onclick = () => {
  clearInterval(timer);
  document.getElementById("answerBox").textContent = selected[current].respuesta;
  document.getElementById("answerBox").classList.remove("hidden");
};

function showQuestion() {
  if (current >= selected.length) {
    alert("No hay mÃ¡s preguntas.");
    return;
  }
  let q = selected[current];
  document.getElementById("questionBox").textContent = `(${q.tema}) ${q.pregunta}`;
  document.getElementById("questionBox").classList.remove("hidden");
  document.getElementById("answerBox").classList.add("hidden");
  document.getElementById("showAnswerBtn").classList.remove("hidden");
  startTimer(() => {
    document.getElementById("answerBox").textContent = q.respuesta;
    document.getElementById("answerBox").classList.remove("hidden");
  });
  current++;
}

function startTimer(callback) {
  let bar = document.getElementById("progress");
  let seconds = 58;
  let total = seconds;
  bar.style.width = "100%";
  bar.style.background = "green";
  document.querySelector(".progress-bar").classList.remove("hidden");

  clearInterval(timer);
  timer = setInterval(() => {
    seconds--;
    let percent = (seconds / total) * 100;
    bar.style.width = `${percent}%`;
    if (percent < 30) bar.style.background = "red";
    else if (percent < 60) bar.style.background = "orange";

    if (seconds <= 0) {
      clearInterval(timer);
      callback();
    }
  }, 1000);
}
</script>
</body>
</html>
